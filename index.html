<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SanaveraYou ‚Äî Audio Experiment</title>
<style>
  body { font-family: system-ui; background: #121212; color: #fff; margin: 0; padding: 20px; }
  .container { max-width: 1000px; margin: 0 auto; }
  h1 { margin-bottom: 20px; }
  .search { display: flex; gap: 10px; margin-bottom: 20px; }
  .search input { flex: 1; padding: 10px; border: 1px solid #333; background: #222; color: #fff; border-radius: 5px; }
  .btn { padding: 8px 16px; background: #ff6d00; color: #000; border: none; border-radius: 5px; cursor: pointer; }
  .btn:hover { background: #e65100; }
  .btn-small { padding: 5px 10px; font-size: 12px; margin: 2px; }
  
  .experiments { background: #222; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
  .experiments h3 { margin: 0 0 10px 0; color: #ff6d00; }
  
  .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 80px; }
  .card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 12px; cursor: pointer; }
  .card:hover { background: #333; }
  .card.active { border-color: #ff6d00; }
  .card img { width: 60px; height: 45px; border-radius: 4px; float: left; margin-right: 10px; }
  .title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
  .author { font-size: 12px; color: #aaa; }
  .status { font-size: 11px; padding: 2px 6px; border-radius: 3px; margin-top: 5px; display: inline-block; }
  .status.success { background: #0d4f3c; color: #4ade80; }
  .status.error { background: #4c1d24; color: #f87171; }
  .status.pending { background: #1e3a8a; color: #60a5fa; }
  
  .player { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; border-top: 1px solid #333; padding: 12px; display: flex; align-items: center; gap: 10px; }
  .p-cover { width: 40px; height: 40px; border-radius: 4px; background: #000; background-size: cover; }
  .p-info { flex: 1; min-width: 0; }
  .p-title { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .p-time { font-size: 12px; color: #aaa; }
  .p-mode { font-size: 10px; color: #ff6d00; }
  .controls { display: flex; gap: 8px; }
  .control-btn { width: 35px; height: 35px; border: 1px solid #333; background: #222; color: #fff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .control-btn:hover { background: #ff6d00; color: #000; }
  
  #seek { flex: 1; margin: 0 10px; }
  #vol { width: 80px; }
  #yt-holder { position: absolute; left: -9999px; opacity: 0; }
  #audio-player { display: none; }
  #status { margin: 10px 0; color: #aaa; }
</style>
</head>
<body>
  <div class="container">
    <h1>SanaveraYou ‚Äî Audio Experiment</h1>
    
    <div class="search">
      <input id="q" placeholder="Buscar en YouTube" />
      <button id="btnSearch" class="btn">Buscar</button>
    </div>
    
    <div class="experiments">
      <h3>üß™ Experimentos</h3>
      <button id="btnTestInvidious" class="btn btn-small">Test Invidious</button>
      <button id="btnTestProxy" class="btn btn-small">Test Proxy</button>
      <button id="btnTestDirect" class="btn btn-small">Test API</button>
      <button id="btnToggleMode" class="btn btn-small">Modo: <span id="modeText">YouTube</span></button>
    </div>
    
    <div id="status"></div>
    <div id="results" class="results"></div>
  </div>

  <div class="player">
    <div id="pCover" class="p-cover"></div>
    <div class="p-info">
      <div id="pTitle" class="p-title">Eleg√≠ un video</div>
      <div class="p-time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      <div id="pMode" class="p-mode">YouTube Mode</div>
    </div>
    <div class="controls">
      <button id="btnPrev" class="control-btn">‚èÆ</button>
      <button id="btnPlay" class="control-btn">‚ñ∂Ô∏è</button>
      <button id="btnNext" class="control-btn">‚è≠</button>
    </div>
    <input id="seek" type="range" min="0" max="1000" value="0" />
    <input id="vol" type="range" min="0" max="100" value="100" />
  </div>

  <div id="yt-holder"><div id="player"></div></div>
  <audio id="audio-player"></audio>

<script>
const $ = s => document.querySelector(s);
const fmtTime = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;

let items = [], idx = -1, ytPlayer = null, audioPlayer = $("#audio-player"), timeTimer = null, playbackMode = 'youtube';

// Audio extraction experiments
async function tryInvidious(videoId) {
  const instances = ['https://yewtu.be', 'https://invidious.kavin.rocks'];
  for (const instance of instances) {
    try {
      const res = await fetch(`${instance}/api/v1/videos/${videoId}`);
      const data = await res.json();
      const audioFormats = data.adaptiveFormats?.filter(f => f.type?.includes('audio') && f.url);
      if (audioFormats?.length) return audioFormats[0].url;
    } catch (e) {
      console.log(`${instance} failed:`, e.message);
    }
  }
  return null;
}

async function tryProxy(videoId) {
  const proxies = ['https://api.allorigins.win/raw?url='];
  for (const proxy of proxies) {
    try {
      const url = `https://www.youtube.com/watch?v=${videoId}`;
      const html = await fetch(proxy + encodeURIComponent(url)).then(r => r.text());
      const match = html.match(/ytInitialPlayerResponse\s*=\s*({.+?});/);
      if (match) {
        const data = JSON.parse(match[1]);
        const audioFormats = data.streamingData?.adaptiveFormats?.filter(f => f.mimeType?.includes('audio') && f.url);
        if (audioFormats?.length) return audioFormats[0].url;
      }
    } catch (e) {
      console.log(`Proxy failed:`, e.message);
    }
  }
  return null;
}

async function tryDirectAPI(videoId) {
  try {
    const res = await fetch('https://www.youtube.com/youtubei/v1/player', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        context: { client: { clientName: "WEB", clientVersion: "2.20230101" } },
        videoId
      })
    });
    const data = await res.json();
    const audioFormats = data.streamingData?.adaptiveFormats?.filter(f => f.mimeType?.includes('audio') && f.url);
    if (audioFormats?.length) return audioFormats[0].url;
  } catch (e) {
    console.log('Direct API failed (CORS expected):', e.message);
  }
  return null;
}

async function extractAudio(videoId) {
  let url = await tryInvidious(videoId);
  if (url) return url;
  url = await tryProxy(videoId);
  if (url) return url;
  return await tryDirectAPI(videoId);
}

// Search
async function searchYouTube(q) {
  $("#status").textContent = "Buscando...";
  try {
    const html = await fetch(`https://r.jina.ai/http://www.youtube.com/results?search_query=${encodeURIComponent(q)}`)
      .then(r => r.text());
    const ids = [...new Set([...html.matchAll(/watch\?v=([\w-]{11})/g)].map(m => m[1]))].slice(0, 8);
    
    const results = [];
    for (const id of ids) {
      try {
        const meta = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`).then(r => r.json());
        const item = {
          id, 
          title: meta.title || `Video ${id}`,
          thumb: `https://img.youtube.com/vi/${id}/hqdefault.jpg`,
          author: meta.author_name || "YouTube",
          audioUrl: null,
          audioStatus: 'pending'
        };
        results.push(item);
        
        // Extract audio in background
        extractAudio(id).then(audioUrl => {
          item.audioUrl = audioUrl;
          item.audioStatus = audioUrl ? 'success' : 'error';
          renderResults();
        });
      } catch (_) {
        results.push({ id, title: `Video ${id}`, thumb: `https://img.youtube.com/vi/${id}/hqdefault.jpg`, author: "YouTube", audioStatus: 'error' });
      }
    }
    
    $("#status").textContent = `${results.length} resultados`;
    return results;
  } catch (e) {
    $("#status").textContent = "Error en b√∫squeda";
    return [];
  }
}

function renderResults() {
  $("#results").innerHTML = items.map((it, i) => {
    const statusClass = it.audioStatus === 'success' ? 'success' : it.audioStatus === 'error' ? 'error' : 'pending';
    const statusText = it.audioStatus === 'success' ? 'Audio ‚úì' : it.audioStatus === 'error' ? 'Sin audio' : 'Extrayendo...';
    
    return `<div class="card ${i === idx ? 'active' : ''}" onclick="playIndex(${i}, true)">
      <img src="${it.thumb}" onerror="this.style.display='none'">
      <div class="title">${it.title}</div>
      <div class="author">${it.author}</div>
      <div class="status ${statusClass}">${statusText}</div>
    </div>`;
  }).join('');
}

// YouTube API
let YT_READY = false;
function loadYTApi() {
  if (window.YT?.Player) { onYouTubeIframeAPIReady(); return; }
  const s = document.createElement("script");
  s.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
}
window.onYouTubeIframeAPIReady = function () {
  ytPlayer = new YT.Player('player', {
    width: 300, height: 150, videoId: '',
    playerVars: { autoplay: 0, controls: 0, rel: 0, playsinline: 1 },
    events: {
      'onReady': () => { YT_READY = true; },
      'onStateChange': onYTState
    }
  });
};
function onYTState(e) {
  if (playbackMode !== 'youtube') return;
  if (e.data === YT.PlayerState.PLAYING) { startTimer(); $("#btnPlay").textContent = "‚è∏"; }
  if (e.data === YT.PlayerState.PAUSED) { stopTimer(); $("#btnPlay").textContent = "‚ñ∂Ô∏è"; }
  if (e.data === YT.PlayerState.ENDED) { stopTimer(); next(); }
}

// Audio events
audioPlayer.onplay = () => { $("#btnPlay").textContent = "‚è∏"; startTimer(); };
audioPlayer.onpause = () => { $("#btnPlay").textContent = "‚ñ∂Ô∏è"; stopTimer(); };
audioPlayer.onended = () => { stopTimer(); next(); };
audioPlayer.onerror = () => $("#status").textContent = "Error reproduciendo audio";

// Playback
function playIndex(i, autoplay = false) {
  if (!items[i]) return;
  idx = i;
  const it = items[i];
  
  $("#pCover").style.backgroundImage = `url('${it.thumb}')`;
  $("#pTitle").textContent = it.title;
  
  if (playbackMode === 'audio' && it.audioUrl) {
    $("#pMode").textContent = "Audio Mode";
    audioPlayer.src = it.audioUrl;
    if (autoplay) audioPlayer.play().catch(() => {
      playbackMode = 'youtube';
      $("#modeText").textContent = "YouTube";
      playIndex(i, autoplay);
    });
  } else {
    if (!YT_READY) return;
    $("#pMode").textContent = "YouTube Mode";
    ytPlayer.loadVideoById(it.id);
    if (!autoplay) ytPlayer.pauseVideo();
  }
  renderResults();
}

function togglePlay() {
  if (playbackMode === 'audio') {
    audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
  } else {
    if (!YT_READY) return;
    ytPlayer.getPlayerState() === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
  }
}

function prev() { if (idx > 0) playIndex(idx - 1, true); }
function next() { if (idx + 1 < items.length) playIndex(idx + 1, true); }

function startTimer() {
  clearInterval(timeTimer);
  timeTimer = setInterval(() => {
    let cur = 0, dur = 0;
    if (playbackMode === 'audio') {
      cur = audioPlayer.currentTime || 0;
      dur = audioPlayer.duration || 0;
    } else if (YT_READY) {
      cur = ytPlayer.getCurrentTime() || 0;
      dur = ytPlayer.getDuration() || 0;
    }
    $("#cur").textContent = fmtTime(Math.floor(cur));
    $("#dur").textContent = fmtTime(Math.floor(dur));
    $("#seek").value = dur ? (cur / dur) * 1000 : 0;
  }, 500);
}

function stopTimer() { clearInterval(timeTimer); }

// Events
$("#btnSearch").onclick = async () => {
  const q = $("#q").value.trim();
  if (!q) return;
  items = await searchYouTube(q);
  idx = -1;
  renderResults();
};
$("#q").onkeydown = e => e.key === "Enter" && $("#btnSearch").click();
$("#btnPlay").onclick = togglePlay;
$("#btnPrev").onclick = prev;
$("#btnNext").onclick = next;
$("#seek").oninput = e => {
  const frac = e.target.value / 1000;
  if (playbackMode === 'audio') {
    audioPlayer.currentTime = frac * (audioPlayer.duration || 0);
  } else if (YT_READY) {
    ytPlayer.seekTo(frac * (ytPlayer.getDuration() || 0), true);
  }
};
$("#vol").oninput = e => {
  const vol = e.target.value;
  if (playbackMode === 'audio') {
    audioPlayer.volume = vol / 100;
  } else if (YT_READY) {
    ytPlayer.setVolume(vol);
  }
};

// Experiment buttons
$("#btnTestInvidious").onclick = async () => {
  if (!items.length) return $("#status").textContent = "Busca videos primero";
  $("#status").textContent = "Probando Invidious...";
  const url = await tryInvidious(items[0].id);
  $("#status").textContent = url ? `‚úÖ Invidious: ${url.slice(0,50)}...` : "‚ùå Invidious fall√≥";
};

$("#btnTestProxy").onclick = async () => {
  if (!items.length) return $("#status").textContent = "Busca videos primero";
  $("#status").textContent = "Probando Proxy...";
  const url = await tryProxy(items[0].id);
  $("#status").textContent = url ? `‚úÖ Proxy: ${url.slice(0,50)}...` : "‚ùå Proxy fall√≥";
};

$("#btnTestDirect").onclick = async () => {
  if (!items.length) return $("#status").textContent = "Busca videos primero";
  $("#status").textContent = "Probando API directa...";
  const url = await tryDirectAPI(items[0].id);
  $("#status").textContent = url ? `‚úÖ API: ${url.slice(0,50)}...` : "‚ùå API fall√≥ (CORS)";
};

$("#btnToggleMode").onclick = () => {
  playbackMode = playbackMode === 'youtube' ? 'audio' : 'youtube';
  $("#modeText").textContent = playbackMode === 'youtube' ? 'YouTube' : 'Audio';
  $("#pMode").textContent = `${playbackMode} Mode`;
  $("#status").textContent = `Modo: ${playbackMode}`;
};

// Init
loadYTApi();
</script>
</body>
</html>
