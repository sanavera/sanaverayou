<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SanaveraYou ‚Äî Audio directo (multi-fallback)</title>
<style>
  :root{--bg:#0b0c10;--panel:#14151c;--card:#10121a;--border:#26283a;--accent:#ff6d00;--accent2:#ff9a3c;--txt:#f5f7ff;--muted:#9aa3b8}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
  background:radial-gradient(1300px 700px at 10% -10%,#1b1e2f55,transparent 60%),radial-gradient(1000px 600px at 90% -20%,#3a214a55,transparent 60%),linear-gradient(180deg,#090a12,var(--bg) 35%);
  display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px) saturate(1.2);
    background:linear-gradient(180deg,#0e0f18cc,#0e0f18aa 60%,transparent);border-bottom:1px solid var(--border);padding:14px 16px}
  h1{margin:0 0 10px;font-size:18px;font-weight:800}
  .row{display:flex;gap:10px}
  input,button{border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--txt)}
  input{flex:1;min-width:0;padding:10px 12px;font-size:15px;outline:none}
  button{padding:10px 14px;cursor:pointer;font-weight:700}
  .btn{background:var(--accent);border-color:#c14e00;color:#000}
  main{max-width:1100px;margin:0 auto;padding:16px;flex:1;width:100%}
  #status{font-size:13px;color:var(--muted);margin:8px 2px 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  @media (max-width:600px){.grid{grid-template-columns:1fr}}
  .card{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer;transition:.15s}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px #0006}
  .thumb{width:64px;height:64px;border-radius:10px;background:#000;background-size:cover;background-position:center;flex:0 0 64px}
  .meta{min-width:0}.title{font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:12px;color:var(--muted)}
  .active{outline:2px solid var(--accent)}
  .player{position:sticky;bottom:0;left:0;right:0;z-index:8;background:var(--panel);border-top:1px solid var(--border);
    padding:10px 12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .p-cover{width:48px;height:48px;border-radius:10px;background:#000;background-size:cover;background-position:center}
  .p-info{min-width:0}
  .p-title{font-size:14px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .p-time{font-size:12px;color:var(--muted)}
  .ctrls{display:flex;gap:8px;align-items:center}
  .icon{display:grid;place-items:center;width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:#0f1118;cursor:pointer}
  .icon svg{width:18px;height:18px}.icon:hover{background:var(--accent2);color:#000}
  .seek{grid-column:1 / -1;display:flex;align-items:center;gap:10px}
  input[type=range]{width:100%;accent-color:var(--accent);cursor:pointer}
  .loading::after{content:" ‚è≥";animation:spin 1s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
  .note{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
  <header>
    <h1>SanaveraYou ‚Äî Audio directo (multi-fallback)</h1>
    <div class="row">
      <input id="q" placeholder="Buscar en YouTube (ej: Amar Azul ‚Äì Yo tomo)" autocomplete="off" />
      <button id="go" class="btn">Buscar</button>
    </div>
  </header>

  <main>
    <div id="status"></div>
    <section id="results" class="grid"></section>
  </main>

  <div class="player">
    <div id="pCover" class="p-cover"></div>
    <div class="p-info">
      <div id="pTitle" class="p-title">Eleg√≠ un resultado</div>
      <div class="p-time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      <div class="note">Intento Piped ‚Üí Invidious proxied (251/140). Si uno falla, paso al siguiente.</div>
    </div>
    <div class="ctrls">
      <button id="btnPrev" class="icon" title="Anterior" aria-label="Anterior">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zM20 12 10 6v12z"/></svg>
      </button>
      <button id="btnPlay" class="icon" title="Reproducir/Pausar" aria-label="Reproducir o Pausar">
        <svg id="icPlay" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="btnNext" class="icon" title="Siguiente" aria-label="Siguiente">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zM4 12l10 6V6z"/></svg>
      </button>
    </div>
    <div class="seek">
      <input id="seek" type="range" min="0" max="1000" value="0" />
      <span style="width:90px;display:flex;align-items:center;gap:6px">
        üîä <input id="vol" type="range" min="0" max="100" value="100" />
      </span>
    </div>
    <audio id="audio" preload="none" crossorigin="anonymous"></audio>
  </div>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = s => { s=Math.max(0,Math.floor(s||0)); const m=Math.floor(s/60), ss=s%60; return `${m}:${String(ss).padStart(2,'0')}`; };
const setStatus = (t, loading=false)=>{ const el=$("#status"); el.textContent=t||""; el.classList.toggle("loading",loading); };
const timeout = (ms, p) => Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),ms))]);

/* ===== State ===== */
let items = []; // [{id,title,author,thumb}]
let idx = -1;
const audio = $("#audio");
let timeTimer = null;

/* ===== Providers ===== */
// Piped Streams API ‚Üí devuelve audioStreams[].url (a veces directo a googlevideo, a veces proxied)
const PIPED = [
  "https://piped.video",
  "https://watch.leptons.xyz",
  "https://piped.projectsegfau.lt",
  "https://piped.in.projectsegfau.lt"
];

// Invidious proxied stream: /latest_version?id=VIDEO&itag=251|140&local=true
const INVIDIOUS = [
  "https://yewtu.be",
  "https://iv.ggtyler.dev",
  "https://invidious.flokinet.to",
  "https://inv.nadeko.net"
];

// Construye una cola de URLs candidatas (Piped ‚Üí Invidious 251 ‚Üí Invidious 140)
async function buildCandidates(id){
  const urls = [];

  // 1) Piped (varias instancias)
  for (const base of PIPED){
    try{
      const u = `${base.replace(/\/$/,'')}/api/v1/streams/${id}`;
      const r = await timeout(5000, fetch(u, {headers:{'Accept':'application/json'}}));
      if (!r.ok) continue;
      const j = await r.json();
      const auds = (j.audioStreams||[]).slice().sort((a,b)=>(b.bitrate||0)-(a.bitrate||0));
      for (const a of auds){
        if (/audio\/webm|audio\/mp4|audio\/m4a/i.test(a.mimeType)) {
          urls.push(a.url);
        }
      }
    }catch(_){}
  }

  // 2) Invidious proxied (251 webm/opus)
  for (const base of INVIDIOUS){
    urls.push(`${base.replace(/\/$/,'')}/latest_version?id=${id}&itag=251&local=true`);
  }
  // 3) Invidious proxied (140 m4a)
  for (const base of INVIDIOUS){
    urls.push(`${base.replace(/\/$/,'')}/latest_version?id=${id}&itag=140&local=true`);
  }

  // Devolvemos √∫nicos, por si repiti√≥
  return [...new Set(urls)];
}

/* ===== Search (scraping v√≠a r.jina.ai) ===== */
async function searchYouTube(q){
  setStatus("Buscando‚Ä¶", true);
  const url = `https://r.jina.ai/http://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
  const html = await timeout(8000, fetch(url, {headers:{'Accept':'text/plain'}}).then(r=>r.text()));
  const ids = Array.from(html.matchAll(/watch\?v=([\w-]{11})/g)).map(m=>m[1]);
  const uniq = [...new Set(ids)].slice(0, 14);
  const filtered = uniq.slice(0, 12);

  const out = [];
  for (const id of filtered){
    try{
      const meta = await timeout(4000, fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`).then(r=>r.json()));
      out.push({
        id,
        title: meta.title || `Video ${id}`,
        author: meta.author_name || "YouTube",
        thumb: (meta.thumbnail_url || `https://img.youtube.com/vi/${id}/hqdefault.jpg`).replace('http://','https://')
      });
    }catch(_){
      out.push({ id, title:`Video ${id}`, author:"YouTube", thumb:`https://img.youtube.com/vi/${id}/hqdefault.jpg` });
    }
  }
  setStatus(`Resultados: ${out.length}`);
  return out;
}

/* ===== Render ===== */
function renderResults(){
  const root = $("#results"); root.innerHTML="";
  items.forEach((it,i)=>{
    const card = document.createElement("button");
    card.className = "card"+(i===idx?" active":"");
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${it.thumb.replace(/'/g,"%27")}')"></div>
      <div class="meta">
        <div class="title" title="${it.title.replace(/"/g,"&quot;")}">${it.title}</div>
        <div class="sub">${it.author}</div>
      </div>`;
    card.onclick = ()=> playIndex(i,true);
    root.appendChild(card);
  });
}
function setCoverAndTitle(it){
  $("#pCover").style.backgroundImage = `url('${it.thumb.replace(/'/g,"%27")}')`;
  $("#pTitle").textContent = it.title;
}

/* ===== Player ===== */
function startTimer(){ stopTimer(); timeTimer = setInterval(()=>{
  const cur = audio.currentTime||0, dur = audio.duration||0;
  $("#cur").textContent = fmt(cur);
  $("#dur").textContent = isFinite(dur)? fmt(dur) : "0:00";
  $("#seek").value = (isFinite(dur)&&dur>0) ? Math.floor((cur/dur)*1000) : 0;
}, 250);}
function stopTimer(){ clearInterval(timeTimer); timeTimer=null; }
function showPauseIcon(isPlaying){
  $("#btnPlay").innerHTML = isPlaying
    ? `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>`
    : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
}

/* ===== Fallback player logic ===== */
let currentCandidates = [];
let currentCandidateIdx = -1;
let candidateTimer = null;

function clearCandidateTimer(){
  if (candidateTimer){ clearTimeout(candidateTimer); candidateTimer = null; }
}

async function tryNextCandidate(autoplay){
  clearCandidateTimer();
  currentCandidateIdx++;
  const url = currentCandidates[currentCandidateIdx];
  if (!url){
    setStatus("No se pudo cargar el audio (todas las fuentes fallaron).");
    return;
  }
  // Setear y probar
  setStatus("Cargando audio‚Ä¶", true);
  audio.src = url;
  audio.load();

  let resolved = false;

  const onCanPlay = async ()=>{
    if (resolved) return;
    resolved = true;
    audio.removeEventListener("canplay", onCanPlay);
    audio.removeEventListener("error", onErr);
    clearCandidateTimer();
    setStatus("Reproduciendo");
    if (autoplay) { await audio.play().catch(()=>{}); }
    showPauseIcon(!audio.paused);
    startTimer();
  };
  const onErr = ()=>{
    if (resolved) return;
    audio.removeEventListener("canplay", onCanPlay);
    audio.removeEventListener("error", onErr);
    // Intentar el siguiente
    tryNextCandidate(autoplay);
  };

  audio.addEventListener("canplay", onCanPlay, {once:true});
  audio.addEventListener("error", onErr, {once:true});

  // Timeout duro por si el canplay no llega
  candidateTimer = setTimeout(()=>{
    onErr();
  }, 7000);
}

async function playIndex(i, autoplay=false){
  if(!items[i]) return;
  idx = i;
  const it = items[i];
  setCoverAndTitle(it);
  renderResults();

  try{
    currentCandidates = await buildCandidates(it.id);
    currentCandidateIdx = -1;
    if (currentCandidates.length === 0){
      setStatus("No se encontraron fuentes de audio.");
      return;
    }
    await tryNextCandidate(autoplay);
  }catch(e){
    console.error(e);
    setStatus("Error preparando fuentes de audio.");
  }
}

/* ===== Wire UI ===== */
$("#go").onclick = async ()=>{
  const q = $("#q").value.trim();
  if(!q) return;
  try{
    setStatus("Buscando‚Ä¶", true);
    items = await searchYouTube(q);
    idx = -1; renderResults();
  }catch(e){
    console.error(e);
    setStatus("La b√∫squeda fall√≥ (proxy ca√≠do). Prob√° de nuevo.");
  }
};
$("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#go").click(); });

$("#btnPlay").onclick = ()=>{ if(audio.paused){ audio.play(); showPauseIcon(true);} else { audio.pause(); showPauseIcon(false);} };
$("#btnPrev").onclick = ()=>{ if(idx>0) playIndex(idx-1,true); };
$("#btnNext").onclick = ()=>{ if(idx+1<items.length) playIndex(idx+1,true); };

$("#seek").addEventListener("input", e=>{
  const v = parseInt(e.target.value,10)/1000;
  const d = audio.duration||0; if(d>0) audio.currentTime = v*d;
});
$("#vol").addEventListener("input", e=>{
  audio.volume = (parseInt(e.target.value,10)/100);
  localStorage.setItem("vol", String(audio.volume));
});
const v0 = parseFloat(localStorage.getItem("vol")); if(!Number.isNaN(v0)) { audio.volume = Math.min(1, Math.max(0, v0)); $("#vol").value = Math.round(audio.volume*100); }

audio.addEventListener("play", ()=>{ showPauseIcon(true); startTimer(); });
audio.addEventListener("pause", ()=>{ showPauseIcon(false); stopTimer(); });
audio.addEventListener("ended", ()=>{ stopTimer(); if(idx+1<items.length) playIndex(idx+1,true); });
audio.addEventListener("loadedmetadata", ()=>{ $("#dur").textContent = isFinite(audio.duration)? fmt(audio.duration):"0:00"; });
</script>
</body>
</html>
