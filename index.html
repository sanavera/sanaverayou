<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reproductor YouTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ece5dd;
      margin: 0;
      padding: 0;
    }
    #app {
      max-width: 600px;
      margin: auto;
      padding: 10px;
    }
    #results {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .card {
      display: flex;
      align-items: center;
      border: none;
      background: #fff;
      border-radius: 8px;
      padding: 5px;
      cursor: pointer;
      text-align: left;
    }
    .card.active {
      border: 2px solid #25d366;
    }
    .thumb {
      width: 80px;
      height: 60px;
      background-size: cover;
      background-position: center;
      border-radius: 6px;
      margin-right: 10px;
    }
    .meta {
      flex: 1;
      overflow: hidden;
    }
    .title {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle {
      font-size: 0.9em;
      color: gray;
    }
    #playerWrap {
      margin-top: 10px;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    #seek {
      flex: 1;
    }
    #pausedNotice {
      display: none;
      color: red;
      font-weight: bold;
      text-align: center;
      margin-top: 5px;
    }
    #pausedNotice.show {
      display: block;
    }
  </style>
</head>
<body>
  <div id="app">
    <h2>Buscador de música</h2>
    <input id="q" placeholder="Escribí tu mensaje o #Nombre de canción" style="width:70%">
    <button id="btnSearch">Buscar</button>
    <div id="results"></div>

    <div id="playerWrap">
      <div id="player"></div>
      <div id="pTitle" style="margin-top:8px; font-weight:bold;"></div>
      <div id="pCover" style="width:100%;height:150px;background-size:cover;background-position:center;border-radius:10px;margin-top:5px;"></div>
      <div id="controls">
        <button id="btnPrev">⏮</button>
        <button id="btnPlay">▶️</button>
        <button id="btnNext">⏭</button>
        <span id="cur">0:00</span> /
        <span id="dur">0:00</span>
        <input type="range" id="seek" min="0" max="1000" value="0">
        <input type="range" id="vol" min="0" max="100" value="100">
      </div>
      <div id="pausedNotice">⏸ Secuencia de fuera de foco activada</div>
    </div>
  </div>

  <script>
  const $ = s => document.querySelector(s);
  const fmtTime = s => {
    s = Math.max(0, Math.floor(s || 0));
    const m = Math.floor(s / 60), ss = s % 60;
    return `${m}:${String(ss).padStart(2, '0')}`;
  };

  let items = [];
  let idx = -1;
  let ytPlayer = null;
  let timeTimer = null;
  let seqTimer1 = null, seqTimer2 = null; // timers de la secuencia
  let YT_READY = false;

  async function searchYouTube(q) {
    const endpoint = `https://r.jina.ai/http://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
    const html = await fetch(endpoint, { headers: { 'Accept': 'text/plain' } }).then(r => r.text()).catch(() => null);
    if (!html) return [];
    const ids = [...new Set(Array.from(html.matchAll(/watch\?v=([\w-]{11})/g)).map(m => m[1]))].slice(0, 12);
    const out = [];
    for (const id of ids) {
      try {
        const meta = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`).then(r => r.json());
        out.push({ id, title: meta.title, thumb: meta.thumbnail_url, author: meta.author_name });
      } catch {
        out.push({ id, title:`Video ${id}`, thumb:`https://img.youtube.com/vi/${id}/hqdefault.jpg`, author:"YouTube" });
      }
    }
    return out;
  }

  function renderResults() {
    const root = $("#results");
    root.innerHTML = "";
    items.forEach((it, i) => {
      const card = document.createElement("button");
      card.className = "card" + (i === idx ? " active" : "");
      card.innerHTML = `
        <div class="thumb" style="background-image:url('${it.thumb}')"></div>
        <div class="meta"><div class="title">${it.title}</div><div class="subtitle">${it.author}</div></div>`;
      card.onclick = () => playIndex(i, true);
      root.appendChild(card);
    });
  }

  function loadYTApi() {
    if (window.YT && window.YT.Player) { onYouTubeIframeAPIReady(); return; }
    const s = document.createElement("script");
    s.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(s);
  }
  window.onYouTubeIframeAPIReady = function () {
    ytPlayer = new YT.Player('player', {
      videoId: '',
      playerVars: { autoplay: 0, controls: 0, rel: 0, playsinline: 1 },
      events: { 'onReady': () => YT_READY = true }
    });
  };

  function playIndex(i, autoplay = false) {
    if (!YT_READY || !items[i]) return;
    idx = i;
    const it = items[i];
    $("#pCover").style.backgroundImage = `url('${it.thumb}')`;
    $("#pTitle").textContent = it.title;
    ytPlayer.loadVideoById(it.id);
    ytPlayer.setVolume(parseInt($("#vol").value, 10) || 100);
    if (autoplay) ytPlayer.playVideo();
    renderResults();
  }

  function startTimer() {
    stopTimer();
    timeTimer = setInterval(() => {
      if (!YT_READY) return;
      const cur = ytPlayer.getCurrentTime() || 0;
      const dur = ytPlayer.getDuration() || 0;
      $("#cur").textContent = fmtTime(cur);
      $("#dur").textContent = fmtTime(dur);
      $("#seek").value = dur ? Math.floor((cur / dur) * 1000) : 0;
    }, 250);
  }
  function stopTimer() {
    clearInterval(timeTimer);
    timeTimer = null;
  }

  // ✅ Manejo de visibilidad
  function handleVisibilityChange() {
    if (!YT_READY) return;
    clearTimeout(seqTimer1);
    clearTimeout(seqTimer2);

    if (document.visibilityState === "hidden") {
      $("#pausedNotice").classList.add("show");

      // Paso 1: a los 2 segundos → minuto 1 + play
      seqTimer1 = setTimeout(() => {
        ytPlayer.seekTo(60, true);
        ytPlayer.playVideo();

        // Paso 2: a los 10 segundos → siguiente canción + play
        seqTimer2 = setTimeout(() => {
          if (idx+1 < items.length) {
            playIndex(idx+1, true);
          }
        }, 10000);

      }, 2000);

    } else {
      $("#pausedNotice").classList.remove("show");
    }
  }

  $("#btnSearch").addEventListener("click", async () => {
    const q = $("#q").value.trim();
    if (!q) return;
    items = await searchYouTube(q);
    idx = -1;
    renderResults();
  });
  $("#q").addEventListener("keydown", e => { if (e.key === "Enter") $("#btnSearch").click(); });
  $("#btnPlay").onclick = () => { if (YT_READY) ytPlayer.playVideo(); };
  $("#btnPrev").onclick = () => { if (idx > 0) playIndex(idx-1,true); };
  $("#btnNext").onclick = () => { if (idx+1<items.length) playIndex(idx+1,true); };
  $("#seek").addEventListener("input", e => ytPlayer.seekTo((parseInt(e.target.value,10)/1000)*ytPlayer.getDuration(), true));
  $("#vol").addEventListener("input", e => ytPlayer.setVolume(parseInt(e.target.value,10)));
  document.addEventListener("visibilitychange", handleVisibilityChange);

  loadYTApi();
  </script>
</body>
</html>
