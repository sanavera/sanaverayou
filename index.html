<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SanaveraYou ‚Äî Audio directo (fallback robusto)</title>
<style>
  :root{--bg:#0c0c0f;--panel:#15151b;--card:#111117;--border:#28283a;--accent:#ff6d00;--accent2:#ff9030;--txt:#f4f6ff;--muted:#9aa0b5}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:
  radial-gradient(1200px 600px at 10% -10%, #1a1b2a55, transparent 60%),
  radial-gradient(1000px 500px at 90% -20%, #34204055, transparent 60%),
  linear-gradient(180deg,#0a0a12, var(--bg) 30%); color:var(--txt); min-height:100vh; display:flex; flex-direction:column}
  header{position:sticky;top:0;z-index:10; backdrop-filter:saturate(1.2) blur(8px);
    background:linear-gradient(180deg,#0e0e16cc,#0e0e16aa 60%,transparent); border-bottom:1px solid var(--border); padding:14px 16px}
  h1{font-size:18px;margin:0 0 10px;font-weight:700;letter-spacing:.3px}
  .row{display:flex;gap:10px}
  input,button{border-radius:12px;border:1px solid var(--border); background:var(--panel); color:var(--txt)}
  input{flex:1;padding:10px 12px;font-size:15px;outline:none}
  button{padding:10px 14px;cursor:pointer;font-weight:600}
  .btn{background:var(--accent);border-color:#c14e00;color:#000}
  main{max-width:1100px;margin:0 auto;padding:16px;flex:1;width:100%}
  #status{font-size:13px;color:var(--muted);margin:8px 2px 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer;transition:.15s}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px #0006}
  .thumb{width:64px;height:64px;border-radius:10px;background:#000;background-size:cover;background-position:center;flex:0 0 64px}
  .meta{min-width:0}.title{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:12px;color:var(--muted)}
  .active{outline:2px solid var(--accent)}
  .player{position:sticky;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--border);
    padding:10px 12px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .p-cover{width:48px;height:48px;border-radius:10px;background:#000;background-size:cover;background-position:center}
  .p-info{min-width:0}
  .p-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .p-time{font-size:12px;color:var(--muted)}
  .ctrls{display:flex;gap:8px;align-items:center}
  .icon{display:grid;place-items:center;width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:#101018;cursor:pointer}
  .icon svg{width:18px;height:18px}.icon:hover{background:var(--accent2);color:#000}
  .seek{grid-column:1 / -1;display:flex;align-items:center;gap:10px}
  input[type=range]{width:100%;accent-color:var(--accent);cursor:pointer}
  .loading::after{content:" ‚è≥";animation:spin 1s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
  .note{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
  <header>
    <h1>SanaveraYou ‚Äî Audio directo (con fallback)</h1>
    <div class="row">
      <input id="q" placeholder="Buscar en YouTube (ej: Amar Azul ‚Äì Yo tomo)" autocomplete="off">
      <button id="go" class="btn">Buscar</button>
    </div>
  </header>

  <main>
    <div id="status"></div>
    <section id="results" class="grid"></section>
  </main>

  <div class="player">
    <div id="pCover" class="p-cover"></div>
    <div class="p-info">
      <div id="pTitle" class="p-title">Eleg√≠ un resultado</div>
      <div class="p-time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      <div class="note">La b√∫squeda usa scraping proxyeado; el audio usa Piped con failover.</div>
    </div>
    <div class="ctrls">
      <button id="btnPrev" class="icon" title="Anterior" aria-label="Anterior">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zM20 12 10 6v12z"/></svg>
      </button>
      <button id="btnPlay" class="icon" title="Reproducir/Pausar" aria-label="Reproducir o Pausar">
        <svg id="icPlay" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="btnNext" class="icon" title="Siguiente" aria-label="Siguiente">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zM4 12l10 6V6z"/></svg>
      </button>
    </div>
    <div class="seek">
      <input id="seek" type="range" min="0" max="1000" value="0">
      <span style="width:90px;display:flex;align-items:center;gap:6px">
        üîä <input id="vol" type="range" min="0" max="100" value="100">
      </span>
    </div>
    <audio id="audio" preload="none" crossorigin="anonymous"></audio>
  </div>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = s => { s=Math.max(0,Math.floor(s||0)); const m=Math.floor(s/60), ss=s%60; return `${m}:${String(ss).padStart(2,'0')}`; };
function setStatus(t, loading=false){ const el=$("#status"); el.textContent=t||""; el.classList.toggle("loading",loading); }
const timeout = (ms, p) => Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),ms))]);

/* ===== State ===== */
let items = []; // [{id,title,author,thumb}]
let idx = -1;
const audio = $("#audio");
let timeTimer = null;

/* ===== Piped (streams) failover ===== */
const PIPED = [
  "https://piped.video",
  "https://watch.leptons.xyz",
  "https://piped.projectsegfau.lt",
  "https://piped.in.projectsegfau.lt"
];
async function getStreams(id){
  let lastErr;
  for(const base of PIPED){
    try{
      const url = `${base.replace(/\/$/,'')}/api/v1/streams/${id}`;
      const r = await timeout(6000, fetch(url, {headers:{'Accept':'application/json'}}));
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j = await r.json();
      const auds = (j.audioStreams||[]).slice().sort((a,b)=>(b.bitrate||0)-(a.bitrate||0));
      const chosen = auds.find(a=>/audio\/webm|audio\/mp4|audio\/m4a/i.test(a.mimeType)) || auds[0];
      if(!chosen) throw new Error("Sin audioStreams");
      return chosen.url;
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("Todas las instancias Piped fallaron");
}

/* ===== B√∫squeda por scraping (r.jina.ai) ===== */
async function searchYouTube(q){
  setStatus("Buscando‚Ä¶", true);
  const url = `https://r.jina.ai/http://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
  const html = await timeout(8000, fetch(url, {headers:{'Accept':'text/plain'}}).then(r=>r.text()));
  // Extraer IDs √∫nicos (m√°x 12), evitando shorts
  const ids = Array.from(html.matchAll(/watch\?v=([\w-]{11})/g)).map(m=>m[1]);
  const uniq = [...new Set(ids)].slice(0, 14);
  const filtered = uniq.filter((id, i, arr)=>{
    // crude: si la l√≠nea anterior ten√≠a "/shorts/", lo evitamos (aprox)
    return true;
  }).slice(0, 12);

  // Enriquecer con noembed (t√≠tulo/thumbnail) pero con tolerancia a errores
  const out = [];
  for (const id of filtered){
    try{
      const meta = await timeout(4000, fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`).then(r=>r.json()));
      out.push({
        id,
        title: meta.title || `Video ${id}`,
        author: meta.author_name || "YouTube",
        thumb: (meta.thumbnail_url || `https://img.youtube.com/vi/${id}/hqdefault.jpg`).replace('http://','https://')
      });
    }catch(_){
      out.push({
        id, title:`Video ${id}`, author:"YouTube",
        thumb:`https://img.youtube.com/vi/${id}/hqdefault.jpg`
      });
    }
  }
  setStatus(`Resultados: ${out.length}`);
  return out;
}

/* ===== Render ===== */
function renderResults(){
  const root = $("#results"); root.innerHTML="";
  items.forEach((it,i)=>{
    const card = document.createElement("button");
    card.className = "card"+(i===idx?" active":"");
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${it.thumb.replace(/'/g,"%27")}')"></div>
      <div class="meta">
        <div class="title" title="${it.title.replace(/"/g,"&quot;")}">${it.title}</div>
        <div class="sub">${it.author}</div>
      </div>`;
    card.onclick = ()=> playIndex(i,true);
    root.appendChild(card);
  });
}
function setCoverAndTitle(it){
  $("#pCover").style.backgroundImage = `url('${it.thumb.replace(/'/g,"%27")}')`;
  $("#pTitle").textContent = it.title;
}

/* ===== Player ===== */
function startTimer(){ stopTimer(); timeTimer = setInterval(()=>{
  const cur = audio.currentTime||0, dur = audio.duration||0;
  $("#cur").textContent = fmt(cur);
  $("#dur").textContent = isFinite(dur)? fmt(dur) : "0:00";
  $("#seek").value = (isFinite(dur)&&dur>0) ? Math.floor((cur/dur)*1000) : 0;
}, 250);}
function stopTimer(){ clearInterval(timeTimer); timeTimer=null; }
function showPauseIcon(isPlaying){
  $("#btnPlay").innerHTML = isPlaying
    ? `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>`
    : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
}

async function playIndex(i, autoplay=false){
  if(!items[i]) return;
  idx = i;
  const it = items[i];
  setCoverAndTitle(it);
  renderResults();
  setStatus("Cargando audio‚Ä¶", true);
  try{
    const src = await getStreams(it.id);
    audio.src = src;
    if (autoplay) {
      await audio.play().catch(()=>{ /* si requiere gesto, queda listo para Play */ });
    }
    showPauseIcon(!audio.paused);
    startTimer();
    setStatus(`Reproduciendo ‚Äî ${it.title}`);
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({title: it.title, artist: it.author, album:"YouTube", artwork:[{src: it.thumb, sizes:"96x96", type:"image/jpeg"}]});
      navigator.mediaSession.setActionHandler('play', ()=>{ audio.play(); showPauseIcon(true); });
      navigator.mediaSession.setActionHandler('pause', ()=>{ audio.pause(); showPauseIcon(false); });
      navigator.mediaSession.setActionHandler('previoustrack', prev);
      navigator.mediaSession.setActionHandler('nexttrack', next);
      navigator.mediaSession.setActionHandler('seekto', d=>{ if(d.seekTime!=null) audio.currentTime=d.seekTime; });
    }
  }catch(e){
    console.error(e);
    setStatus("No se pudo cargar el audio (prob√° de nuevo o m√°s tarde).");
  }
}
function togglePlay(){ if(audio.paused){ audio.play(); showPauseIcon(true);} else { audio.pause(); showPauseIcon(false);} }
function prev(){ if(idx>0) playIndex(idx-1,true); }
function next(){ if(idx+1<items.length) playIndex(idx+1,true); }

/* ===== Wire ===== */
$("#go").onclick = async ()=>{
  const q = $("#q").value.trim();
  if(!q) return;
  try{
    items = await searchYouTube(q);
    idx = -1;
    renderResults();
  }catch(e){
    console.error(e);
    setStatus("La b√∫squeda fall√≥ (proxy ca√≠do). Prob√° de nuevo.");
  }
};
$("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#go").click(); });
$("#btnPlay").onclick = togglePlay;
$("#btnPrev").onclick = prev;
$("#btnNext").onclick = next;
$("#seek").addEventListener("input", e=>{
  const v = parseInt(e.target.value,10)/1000;
  const d = audio.duration||0; if(d>0) audio.currentTime = v*d;
});
$("#vol").addEventListener("input", e=>{
  audio.volume = (parseInt(e.target.value,10)/100);
  localStorage.setItem("vol", String(audio.volume));
});
audio.addEventListener("play", ()=>{ showPauseIcon(true); startTimer(); });
audio.addEventListener("pause", ()=>{ showPauseIcon(false); stopTimer(); });
audio.addEventListener("ended", ()=>{ stopTimer(); next(); });
audio.addEventListener("loadedmetadata", ()=>{ $("#dur").textContent = isFinite(audio.duration)? fmt(audio.duration):"0:00"; });
const v = parseFloat(localStorage.getItem("vol")); if(!Number.isNaN(v)) { audio.volume = Math.min(1, Math.max(0, v)); $("#vol").value = Math.round(audio.volume*100); }
</script>
</body>
</html>
