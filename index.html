<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SanaveraYou ‚Äî Reproductor simple</title>
<style>
/* ... (todo tu CSS igual que antes, sin cambios) ... */
</style>
</head>
<body>
  <header>
    <h1>SanaveraYou ‚Äî Busc√° y reproduc√≠</h1>
    <div class="search">
      <input id="q" placeholder="Buscar en YouTube (ej: Amar Azul ‚Äì Yo tomo)" autocomplete="off" />
      <button id="btnSearch" class="btn btn-accent">Buscar</button>
    </div>
  </header>

  <main>
    <div id="status" class="subtitle" style="margin: 12px 2px 16px;"></div>
    <section id="results" class="results"></section>
  </main>

  <!-- Player -->
  <div class="player">
    <div id="pCover" class="p-cover"></div>
    <div class="p-info">
      <div id="pTitle" class="p-title">Eleg√≠ un resultado para reproducir</div>
      <div class="p-time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      <div id="pausedNotice" class="paused-notice">Reproducci√≥n pausada</div>
    </div>
    <div class="p-controls">
      <button id="btnPrev" class="icon">‚èÆ</button>
      <button id="btnPlay" class="icon">‚ñ∂Ô∏è</button>
      <button id="btnNext" class="icon">‚è≠</button>
      <button id="btnFullscreen" class="icon">‚§¢</button>
    </div>
    <div class="seek">
      <input id="seek" type="range" min="0" max="1000" value="0" />
    </div>
    <div class="vol">
      üîä <input id="vol" type="range" min="0" max="100" value="100" />
    </div>
  </div>

  <div id="yt-holder"><div id="player"></div></div>

  <footer>SanaveraYou &copy; 2025</footer>

<script>
/* ========= Utils ========= */
const $ = s => document.querySelector(s);
const uniq = a => [...new Set(a)];

/* ========= State ========= */
let items = [];
let idx = -1;
let ytPlayer = null;
let timeTimer = null;
let wasPlaying = false;

/* === NUEVO: auto-forzar play cada 200ms === */
let autoPlayTimer = null;
function startAutoPlay(){
  stopAutoPlay();
  autoPlayTimer = setInterval(() => {
    if (YT_READY && ytPlayer) {
      try { ytPlayer.playVideo(); } catch(e){}
    }
  }, 200); // ‚ö° ajust√° este valor (ms) si quer√©s m√°s r√°pido o m√°s lento
}
function stopAutoPlay(){
  if (autoPlayTimer){
    clearInterval(autoPlayTimer);
    autoPlayTimer = null;
  }
}

/* ========= Search ========= */
async function searchYouTube(q) {
  const endpoint = `https://r.jina.ai/http://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
  const html = await fetch(endpoint, { headers: { 'Accept': 'text/plain' } }).then(r => r.text()).catch(() => null);
  if (!html) return [];
  const ids = uniq(Array.from(html.matchAll(/watch\?v=([\w-]{11})/g)).map(m => m[1])).slice(0, 12);
  const out = [];
  for (const id of ids) {
    try {
      const meta = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`).then(r => r.json());
      out.push({ id, title: meta.title, thumb: meta.thumbnail_url, author: meta.author_name });
    } catch(_) {
      out.push({ id, title: `Video ${id}`, thumb: `https://img.youtube.com/vi/${id}/hqdefault.jpg`, author:"YouTube" });
    }
  }
  return out;
}
function renderResults() {
  const root = $("#results");
  root.innerHTML = "";
  items.forEach((it,i)=>{
    const card=document.createElement("button");
    card.className="card"+(i===idx?" active":"");
    card.innerHTML=`<div class="thumb" style="background-image:url('${it.thumb}')"></div>
      <div class="meta"><div class="title">${it.title}</div><div class="subtitle">${it.author}</div></div>`;
    card.onclick=()=>{ playIndex(i,true); };
    root.appendChild(card);
  });
}

/* ========= YouTube API ========= */
let YT_READY=false;
function loadYTApi(){
  if(window.YT&&window.YT.Player){onYouTubeIframeAPIReady();return;}
  const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api";document.head.appendChild(s);
}
window.onYouTubeIframeAPIReady=function(){
  ytPlayer=new YT.Player('player',{videoId:'',playerVars:{autoplay:0,controls:0,rel:0,playsinline:1},
    events:{'onReady':()=>{YT_READY=true;},'onStateChange':onYTState}});
};
function onYTState(e){
  if(e.data===YT.PlayerState.PLAYING){wasPlaying=true;$("#btnPlay").textContent="‚è∏";}
  if(e.data===YT.PlayerState.PAUSED){wasPlaying=false;$("#btnPlay").textContent="‚ñ∂Ô∏è";}
  if(e.data===YT.PlayerState.ENDED){next();}
}

/* ========= Controls ========= */
function playIndex(i,autoplay=false){
  if(!YT_READY||!items[i])return;
  idx=i;const it=items[i];
  $("#pCover").style.backgroundImage=`url('${it.thumb}')`;
  $("#pTitle").textContent=it.title;
  ytPlayer.loadVideoById(it.id);
  ytPlayer.setVolume(parseInt($("#vol").value,10)||100);
  if(autoplay){
    ytPlayer.playVideo();
    startAutoPlay();
  } else {
    stopAutoPlay();
  }
}
function togglePlay(){ if(!YT_READY)return;
  const st=ytPlayer.getPlayerState();
  if(st===YT.PlayerState.PLAYING){ytPlayer.pauseVideo();stopAutoPlay();}
  else {ytPlayer.playVideo();startAutoPlay();}
}
function prev(){ if(idx>0) playIndex(idx-1,true);}
function next(){ if(idx+1<items.length) playIndex(idx+1,true);}

/* ========= UI ========= */
$("#btnSearch").onclick=async()=>{
  const q=$("#q").value.trim(); if(!q)return;
  items=await searchYouTube(q); idx=-1; renderResults();
};
$("#btnPlay").onclick=togglePlay;
$("#btnPrev").onclick=prev;
$("#btnNext").onclick=next;
$("#btnFullscreen").onclick=()=>{ if(!document.fullscreenElement)document.documentElement.requestFullscreen(); else document.exitFullscreen();};
$("#vol").oninput=e=>{ if(YT_READY)ytPlayer.setVolume(parseInt(e.target.value,10)); };

document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="hidden"&&wasPlaying){$("#pausedNotice").classList.add("show");} else {$("#pausedNotice").classList.remove("show");}});

loadYTApi();
</script>
</body>
</html>
